name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '*.md'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '*.md'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocstrings[python] mkdocs-gen-files
          pip install -e ".[dev]"
      
      - name: Generate API documentation
        run: |
          mkdir -p docs/api
          
          # Generate compiler API docs
          echo "# Compiler API" > docs/api/compiler.md
          echo "" >> docs/api/compiler.md
          echo "Auto-generated API documentation for the Triton compiler." >> docs/api/compiler.md
          
          # Generate backend API docs
          echo "# Backend API" > docs/api/backend.md
          echo "" >> docs/api/backend.md
          echo "Auto-generated API documentation for the Triton backends." >> docs/api/backend.md
          
          # Generate kernels API docs
          echo "# Kernels API" > docs/api/kernels.md
          echo "" >> docs/api/kernels.md
          echo "Auto-generated API documentation for the Triton kernels." >> docs/api/kernels.md
      
      - name: Create mkdocs.yml
        run: |
          cat > mkdocs.yml << 'EOF'
          site_name: Triton DSL Documentation
          site_description: Domain-Specific Language for Ternary Neural Networks
          site_author: Finance Commander
          site_url: https://financecommander.github.io/Triton
          repo_url: https://github.com/financecommander/Triton
          repo_name: financecommander/Triton
          
          theme:
            name: material
            palette:
              - scheme: default
                primary: indigo
                accent: indigo
                toggle:
                  icon: material/brightness-7
                  name: Switch to dark mode
              - scheme: slate
                primary: indigo
                accent: indigo
                toggle:
                  icon: material/brightness-4
                  name: Switch to light mode
            features:
              - navigation.tabs
              - navigation.sections
              - navigation.expand
              - navigation.top
              - search.suggest
              - search.highlight
              - content.code.copy
          
          nav:
            - Home: index.md
            - Getting Started:
              - Quick Start: QUICK_START_CIFAR10.md
              - Quick Reference: QUICK_REFERENCE.md
              - PyTorch Backend: QUICKSTART_PYTORCH_BACKEND.md
            - Guides:
              - CIFAR-10 Training: CIFAR10_TRAINING_GUIDE.md
              - Export Guide: EXPORT_GUIDE.md
            - API Reference:
              - Compiler: api/compiler.md
              - Backend: api/backend.md
              - Kernels: api/kernels.md
            - Development:
              - Changelog: CHANGELOG.md
              - Contributing: CONTRIBUTING.md
          
          markdown_extensions:
            - admonition
            - codehilite
            - pymdownx.highlight:
                anchor_linenums: true
            - pymdownx.inlinehilite
            - pymdownx.snippets
            - pymdownx.superfences
            - pymdownx.details
            - pymdownx.tabbed:
                alternate_style: true
            - tables
            - toc:
                permalink: true
          
          plugins:
            - search
            - gen-files:
                scripts:
                  - docs/gen_ref_pages.py
          EOF
      
      - name: Copy documentation files
        run: |
          cp README.md docs/index.md
          cp CHANGELOG.md docs/CHANGELOG.md || touch docs/CHANGELOG.md
          
          # Create CONTRIBUTING.md if it doesn't exist
          if [ ! -f CONTRIBUTING.md ]; then
            cat > docs/CONTRIBUTING.md << 'EOF'
          # Contributing to Triton DSL
          
          Thank you for your interest in contributing to Triton DSL!
          
          ## Development Setup
          
          1. Clone the repository
          2. Install development dependencies: `pip install -e ".[dev]"`
          3. Run tests: `pytest tests/`
          
          ## Code Style
          
          - Use Black for code formatting
          - Use Ruff for linting
          - Follow type hints conventions
          
          ## Pull Request Process
          
          1. Create a feature branch
          2. Make your changes
          3. Run tests and linting
          4. Submit a pull request
          EOF
          else
            cp CONTRIBUTING.md docs/CONTRIBUTING.md
          fi
      
      - name: Build documentation
        run: mkdocs build --strict
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: site/
          retention-days: 7

  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mkdocs mkdocs-material mkdocstrings[python] mkdocs-gen-files
          pip install -e ".[dev]"
      
      - name: Generate API documentation
        run: |
          mkdir -p docs/api
          echo "# Compiler API" > docs/api/compiler.md
          echo "# Backend API" > docs/api/backend.md
          echo "# Kernels API" > docs/api/kernels.md
      
      - name: Create mkdocs.yml
        run: |
          cat > mkdocs.yml << 'EOF'
          site_name: Triton DSL Documentation
          site_description: Domain-Specific Language for Ternary Neural Networks
          site_author: Finance Commander
          site_url: https://financecommander.github.io/Triton
          repo_url: https://github.com/financecommander/Triton
          repo_name: financecommander/Triton
          
          theme:
            name: material
            palette:
              - scheme: default
                primary: indigo
                accent: indigo
                toggle:
                  icon: material/brightness-7
                  name: Switch to dark mode
              - scheme: slate
                primary: indigo
                accent: indigo
                toggle:
                  icon: material/brightness-4
                  name: Switch to light mode
            features:
              - navigation.tabs
              - navigation.sections
              - navigation.expand
              - navigation.top
              - search.suggest
              - search.highlight
              - content.code.copy
          
          nav:
            - Home: index.md
            - Getting Started:
              - Quick Start: QUICK_START_CIFAR10.md
              - Quick Reference: QUICK_REFERENCE.md
              - PyTorch Backend: QUICKSTART_PYTORCH_BACKEND.md
            - Guides:
              - CIFAR-10 Training: CIFAR10_TRAINING_GUIDE.md
              - Export Guide: EXPORT_GUIDE.md
            - API Reference:
              - Compiler: api/compiler.md
              - Backend: api/backend.md
              - Kernels: api/kernels.md
            - Development:
              - Changelog: CHANGELOG.md
              - Contributing: CONTRIBUTING.md
          
          markdown_extensions:
            - admonition
            - codehilite
            - pymdownx.highlight:
                anchor_linenums: true
            - pymdownx.inlinehilite
            - pymdownx.snippets
            - pymdownx.superfences
            - pymdownx.details
            - pymdownx.tabbed:
                alternate_style: true
            - tables
            - toc:
                permalink: true
          
          plugins:
            - search
          EOF
      
      - name: Copy documentation files
        run: |
          cp README.md docs/index.md
          cp CHANGELOG.md docs/CHANGELOG.md || touch docs/CHANGELOG.md
          if [ ! -f CONTRIBUTING.md ]; then
            cat > docs/CONTRIBUTING.md << 'EOF'
          # Contributing to Triton DSL
          
          Thank you for your interest in contributing to Triton DSL!
          
          ## Development Setup
          
          1. Clone the repository
          2. Install development dependencies: `pip install -e ".[dev]"`
          3. Run tests: `pytest tests/`
          
          ## Code Style
          
          - Use Black for code formatting
          - Use Ruff for linting
          - Follow type hints conventions
          
          ## Pull Request Process
          
          1. Create a feature branch
          2. Make your changes
          3. Run tests and linting
          4. Submit a pull request
          EOF
          else
            cp CONTRIBUTING.md docs/CONTRIBUTING.md
          fi
      
      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force

  check-links:
    name: Check Documentation Links
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check.json'
        continue-on-error: true
